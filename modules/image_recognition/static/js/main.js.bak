document.addEventListener('DOMContentLoaded', function() {
    // 获取DOM元素
    const dropArea = document.getElementById('dropArea');
    const imageInput = document.getElementById('imageInput');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const imagePreviews = document.getElementById('imagePreviews');
    const processButton = document.getElementById('processButton');
    const promptInput = document.getElementById('promptInput');
    const resultContainer = document.getElementById('resultContainer');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const statusIndicator = document.getElementById('status-indicator');
    
    // 存储上传的图片文件
    let uploadedFiles = [];
    
    // 设置默认提示词
    promptInput.value = `请识别图片中的所有文字，并按以下顺序生成三份输出：

1. 【原文输出】  
   原样返回 OCR 识别到的完整文本。

2. 【通用 JSON 输出】  
   将识别结果整理成键值对格式的 JSON，键名可根据识别到的内容自定义，所有识别到的项都要包含。

3. 【指定字段 JSON 输出】  
   严格按照下面的模板生成一个 JSON 对象，字段顺序与模板一致，未识别到的值填 null，禁止多余字段或注释：
{
  "productName": null,             // 商品名称
  "brandName": null,               // 品牌名称
  "orderingInfo": null,            // 规格信息
  "validPeriod": null,             // 有效期
  "sterilizationValidity": null,   // 灭菌有效期
  "guaranteePeriod": null,         // 质保期
  "storage": null,                 // 储存方式
  "useLife": null,                 // 设备使用寿命
  "effectiveComponent": null,      // 有效成分及含量
  "instruction": null,             // 使用说明
  "clinicalOperation": null,       // 临床操作
  "mountingsDesc": null,           // 配件说明
  "maintaining": null,             // 维护/保养
  "productDesc": null,             // 商品介绍
  "sterilization": null            // 消毒灭菌
}`;
    
    // 点击上传区域触发文件选择
    uploadPlaceholder.addEventListener('click', function() {
        imageInput.click();
    });
    
    // 添加更多图片按钮点击
    document.getElementById('addMoreImages').addEventListener('click', function() {
        imageInput.click();
    });
    
    // 处理文件选择
    imageInput.addEventListener('change', function() {
        handleFiles(this.files);
    });
    
    // 创建拖放区域
    const uploadContainer = document.querySelector('.image-upload-container');
    
    // 处理拖放 - 拖动进入
    uploadContainer.addEventListener('dragenter', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadContainer.classList.add('drag-over');
    });
    
    // 处理拖放 - 拖动经过
    uploadContainer.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadContainer.classList.add('drag-over');
    });
    
    // 处理拖放 - 拖动离开
    uploadContainer.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadContainer.classList.remove('drag-over');
    });
    
    // 处理拖放 - 放置文件
    uploadContainer.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadContainer.classList.remove('drag-over');
        
        const dt = e.dataTransfer;
        const files = dt.files;
        
        handleFiles(files);
    });
    
    // 处理文件
    function handleFiles(files) {
        if (files.length === 0) return;
        
        // 清空之前的预览
        if (uploadedFiles.length === 0) {
            imagePreviews.innerHTML = '';
        }
        
        // 处理每个文件
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            
            // 检查是否为图片
            if (!file.type.match('image.*')) {
                continue; // 跳过非图片文件
            }
            
            // 将文件添加到上传列表
            uploadedFiles.push(file);
            
            // 创建预览元素
            const previewItem = document.createElement('div');
            previewItem.className = 'image-preview-item';
            previewItem.dataset.index = uploadedFiles.length - 1;
            
            // 创建图片预览
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            previewItem.appendChild(img);
            
            // 创建删除按钮
            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn btn-sm btn-danger remove-image';
            removeBtn.innerHTML = '<i class="bi bi-x-lg"></i>';
            removeBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                const index = parseInt(previewItem.dataset.index);
                // 从数组中移除文件
                uploadedFiles.splice(index, 1);
                // 移除预览元素
                previewItem.remove();
                // 更新其他预览元素的索引
                updatePreviewIndices();
                // 如果没有图片，显示占位符
                if (uploadedFiles.length === 0) {
                    uploadPlaceholder.style.display = 'block';
                    processButton.disabled = true;
                }
            });
            previewItem.appendChild(removeBtn);
            
            // 添加到预览区域
            imagePreviews.appendChild(previewItem);
        }
        
        // 隐藏占位符，启用处理按钮
        if (uploadedFiles.length > 0) {
            uploadPlaceholder.style.display = 'none';
            processButton.disabled = false;
        }
    }
    
    // 更新预览元素的索引
    function updatePreviewIndices() {
        const previewItems = imagePreviews.querySelectorAll('.image-preview-item');
        previewItems.forEach((item, index) => {
            item.dataset.index = index;
        });
    }
    
    // 清空所有图片
    function clearAllImages() {
        // 释放所有URL对象
        const previewItems = imagePreviews.querySelectorAll('.image-preview-item img');
        previewItems.forEach(img => {
            if (img.src) {
                URL.revokeObjectURL(img.src);
            }
        });
        
        // 清空预览区域
        imagePreviews.innerHTML = '';
        uploadPlaceholder.style.display = 'block';
        processButton.disabled = true;
        imageInput.value = '';
        uploadedFiles = [];
    }
    
    // 处理图片按钮点击
    processButton.addEventListener('click', function() {
        if (uploadedFiles.length === 0) {
            alert('请先上传图片');
            return;
        }
        
        // 隐藏下载按钮
        document.getElementById('downloadResults').style.display = 'none';
        
        // 显示加载指示器
        loadingIndicator.classList.remove('d-none');
        processButton.disabled = true;
        
        // 更新状态指示器
        updateStatus('processing');
        
        // 清空之前的结果
        resultContainer.innerHTML = `
            <div class="alert alert-info streaming-text">
                <div id="streaming-result" class="result-text"></div>
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        `;
        
        const streamingResult = document.getElementById('streaming-result');
        
        // 获取提示词
        const prompt = promptInput.value || '请描述这些图片';
        
        // 使用FormData直接发送文件
        const formData = new FormData();
        
        // 添加所有图片文件
        uploadedFiles.forEach((file, index) => {
            formData.append('files', file);
        });
        
        formData.append('prompt', prompt);
        
        // 使用fetch API的流式处理
        
        // 使用FormData直接发送文件
        fetch('/image/recognition/process', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            
            // 检查响应类型
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('text/event-stream')) {
                // 处理流式响应
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                // 递归函数来处理数据流
                function readStream() {
                    return reader.read().then(({ done, value }) => {
                        if (done) {
                            // 流结束
                            loadingIndicator.classList.add('d-none');
                            processButton.disabled = false;
                            return;
                        }
                        
                        // 解码并处理数据
                        const chunk = decoder.decode(value, { stream: true });
                        
                        // 处理SSE格式的数据
                        const lines = chunk.split('\n\n');
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.substring(6));
                                    
                                    if (data.done) {
                                        // 流结束
                                        loadingIndicator.classList.add('d-none');
                                        processButton.disabled = false;
                                        // 移除打字指示器
                                        document.querySelector('.typing-indicator').remove();
                                        // 更新状态
                                        updateStatus('completed');
                                    } else if (data.text) {
                                        // 收集完整的文本，然后使用 Markdown 解析
                                        // 如果还没有存储完整文本，创建一个
                                        if (!streamingResult.fullText) {
                                            streamingResult.fullText = '';
                                        }
                                        
                                        // 添加新文本
                                        streamingResult.fullText += data.text;
                                        
                                        // 使用 Markdown 解析完整文本
                                        streamingResult.innerHTML = formatResult(streamingResult.fullText);
                                        
                                        // 滚动到底部
                                        resultContainer.scrollTop = resultContainer.scrollHeight;
                                    }
                                } catch (e) {
                                    console.error('解析SSE数据出错:', e);
                                }
                            }
                        }
                        
                        // 继续读取
                        return readStream();
                    });
                }
                
                // 开始处理流
                return readStream();
            } else {
                // 非流式响应，回退到普通JSON处理
                return response.json().then(handleResponse);
            }
        })
        .catch(handleError);
    });
    
    // 处理API响应
    function handleResponse(data) {
        // 隐藏加载指示器
        loadingIndicator.classList.add('d-none');
        processButton.disabled = false;
        
        if (data.status === 'success') {
            // 显示结果
            resultContainer.innerHTML = `
                <div class="alert alert-success">
                    <h5 class="alert-heading">识别成功</h5>
                    <hr>
                    <div class="result-text">${formatResult(data.result)}</div>
                </div>
            `;
        } else {
            // 显示错误
            resultContainer.innerHTML = `
                <div class="alert alert-danger">
                    <h5 class="alert-heading">处理失败</h5>
                    <hr>
                    <p>${data.message || '未知错误'}</p>
                </div>
            `;
        }
    }
    
    // 处理错误
    function handleError(error) {
        // 隐藏加载指示器
        loadingIndicator.classList.add('d-none');
        processButton.disabled = false;
        
        // 更新状态
        updateStatus('error');
        
        // 显示错误
        resultContainer.innerHTML = `
            <div class="alert alert-danger">
                <h5 class="alert-heading">请求失败</h5>
                <hr>
                <p>无法连接到服务器，请稍后再试</p>
                <p class="text-muted small">错误详情: ${error.message}</p>
            </div>
        `;
    }
    
    // 格式化结果文本，使用 Markdown 解析
    function formatResult(text) {
        if (!text) return '';
        
        try {
            // 使用 marked.js 解析 Markdown
            return marked.parse(text);
        } catch (e) {
            console.error('Markdown 解析错误:', e);
            // 降级处理：如果 marked 解析失败，回退到基本的 HTML 转换
            return text
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
        }
    }
    
    // 更新状态指示器
    function updateStatus(status) {
        // 清除所有状态类
        const statusBadge = statusIndicator.querySelector('.badge');
        statusBadge.className = 'badge me-2';
        
        // 根据状态设置样式和文本
        switch(status) {
            case 'idle':
                statusBadge.classList.add('bg-secondary');
                statusBadge.textContent = '尚未开始';
                break;
            case 'processing':
                statusBadge.classList.add('bg-primary', 'processing');
                statusBadge.textContent = '正在处理';
                break;
            case 'completed':
                statusBadge.classList.add('bg-success', 'completed');
                statusBadge.textContent = '处理完成';
                // 显示下载按钮
                let resultText = ''; // 存储识别结果文本
                let source = null;             document.getElementById('downloadResults').style.display = 'block';
                }
                break;
            case 'error':
                statusBadge.classList.add('bg-danger', 'error');
                statusBadge.textContent = '处理错误';
{{ ... }}
                    const generalText = generalMatch[0].replace(/(?:通用 JSON 输出|【通用 JSON 输出】)\s*/i, '').trim();
                    // 尝试提取JSON部分
                    const jsonMatch = generalText.match(/{[\s\S]*?}/i);
                    if (jsonMatch) {
                        result.general = jsonMatch[0];
                    // 将文本添加到结果容器
                    resultText += data.text; // 累加文本到resultText变量
                    resultContainer.innerHTML = marked.parse(data.text);
                }    }
                    console.log('提取到通用JSON:', result.general.substring(0, 50) + '...');
                }
            }
            
            // 尝试提取指定字段 JSON 输出
{{ ... }}
                const specifiedRegex = /(?:指定字段 JSON 输出|【指定字段 JSON 输出】)[\s\S]*/i;
                const specifiedMatch = text.match(specifiedRegex);
                if (specifiedMatch) {
                    const specifiedText = specifiedMatch[0].replace(/(?:指定字段 JSON 输出|【指定字段 JSON 输出】)\s*/i, '').trim();
                    // 尝试提取JSON部分
                    const jsonMatch = specifiedText.match(/{[\s\S]*?}/i);
                    if (jsonMatch) {
                        result.specified = jsonMatch[0];
                    } else {
                        result.specified = specifiedText;
                    }
                    console.log('提取到指定字段JSON:', result.specified.substring(0, 50) + '...');
                }
            }
            
            // 如果没有提取到任何内容，将整个文本作为原文
            if (!result.original && !result.general && !result.specified) {
                result.original = text;
                console.log('没有提取到结构化内容，使用全部文本作为原文');
            }
        } catch (error) {
            console.error('解析结果时出错:', error);
            // 出错时将整个文本作为原文
            result.original = text;
        }
        
        return result;
    }
    
    // 下载识别结果
    function downloadResults() {
        if (!resultText) {
            alert('没有可下载的识别结果');
            return;
        }
        
        console.log('准备下载识别结果...');
        
        // 解析结果文本，提取三份内容
        const parts = parseResultContent(resultText);
        
        // 获取商品名称或默认名称
        let folderName = '识别结果';
        let productName = null;
        
        // 尝试从指定字段JSON中提取商品名称
        if (parts.specified) {
            try {
                const specifiedJson = JSON.parse(parts.specified);
                if (specifiedJson && specifiedJson.productName) {
                    productName = specifiedJson.productName;
                    folderName = productName;
                    console.log('从指定字段JSON中提取到商品名称:', productName);
                }
            } catch (e) {
                console.error('解析指定字段JSON失败:', e);
            }
        }
        
        // 如果没有从指定字段中提取到，尝试从通用JSON中提取
        if (!productName && parts.general) {
            try {
                const generalJson = JSON.parse(parts.general);
                if (generalJson && (generalJson.productName || generalJson.name || generalJson.title)) {
                    productName = generalJson.productName || generalJson.name || generalJson.title;
                    folderName = productName;
                    console.log('从通用JSON中提取到商品名称:', productName);
                }
            } catch (e) {
                console.error('解析通用JSON失败:', e);
            }
        }
        
        // 清理文件夹名称，移除非法字符
        folderName = folderName.replace(/[\\/:*?"<>|]/g, '_');
        if (!folderName || folderName.trim() === '') {
            folderName = '识别结果';
        }
        
        console.log('使用文件夹名称:', folderName);
        
        // 创建ZIP文件
        const zip = new JSZip();
        
        // 创建文件夹
        const folder = zip.folder(folderName);
        
        // 添加原文文本文件
        folder.file('原文.txt', parts.original || resultText);
        console.log('添加原文.txt文件');
        
        // 添加通用JSON文件
        folder.file('通用.json', parts.general || '{}');
        console.log('添加通用.json文件');
        
        // 添加指定字段JSON文件
        folder.file('指定.json', parts.specified || '{}');
        console.log('添加指定.json文件');
        
        // 生成ZIP文件并下载
        console.log('开始生成ZIP文件...');
        zip.generateAsync({type: 'blob'})
            .then(function(content) {
                // 使用FileSaver.js保存文件
                saveAs(content, `${folderName}.zip`);
                console.log('ZIP文件生成并下载成功');
            })
            .catch(function(error) {
                console.error('生成ZIP文件失败:', error);
                alert('生成ZIP文件失败: ' + error.message);
            });
    }
    
    // 下载按钮点击事件
    document.getElementById('downloadResults').addEventListener('click', downloadResults);
});
